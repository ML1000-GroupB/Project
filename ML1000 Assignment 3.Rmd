---
title: "ML1000 Assignment 3"
author: "Crystal Zhu"
date: "07/03/2021"
output:
  pdf_document: default
  html_document: default
---

## Data Understanding


### How do we merge the data files?


There are six data files, excluding the sample_submission.csv file, from the Instacart Market Basket Analysis data - aisles.csv, departments.csv, order_products__train.csv, order_products__prior.csv, orders.csv and products.csv.

(Add data file descriptions later!)

Steps:

1. Merged the aisles data with the products data to obtain Merged dataset 1, so that we know which aisle each product belongs to.

2. Combined the Merged dataset 1 with the department data to obtain Merged dataset 2, so we know which aisle and department each product is from.

3. Add Merged dataset 2, which contains product full information, to order_products__train and order_products__prior files, respectively, to obtain Merged dataset 3 (Train) and Merged dataset 4 (Prior), so that we know the product information (e.g. product names, aisles and departments they belong to) of the products in the training and prior orders.






```{r, message=FALSE, warning=FALSE}

library(arules)


####### Convert the merged dataset into a TRANSACTION FORM FOR R ############
X=read.csv("C:/Users/yunan/Downloads/York U/Machine Learning Cert/Assignment 3/data/orders_TRAIN_products_MERGED.csv")


#split(x,f) divides the data in the vector x into the groups defined by f
#split(x,f) returns a list, and the components of the list are named by the levels of f
#so basically it returns the frequency table at each level of f(aka, the frequency of each product in our cases)

orders=unique(X$order_id)

set.seed(123)
#select 100 unique orders for demo
order_sample=sample(orders,100,replace = F)

X1=subset(X,order_id %in% order_sample)

X1$order_id=as.factor(X1$order_id)
X1$product_id=as.factor(X1$product_id)
X1$product_name=as.factor(X1$product_name)

length(unique(X1$product_name))
#39,123 unique product names

#create the item list
Order_by_product <- split(X1$product_name, X1$order_id)

Order_by_product[[1]]
#the first element of Order_by_product is all the items from the first order
length(Order_by_product)
#97
length(unique(X1$order_id))
#97 - so the length of Order_by_product is the number of orders

#Coerce the Item List to the Transactions class
#convert transaction data in dataframe to transaction object
X1_trans <- as(Order_by_product, "transactions")

X1_trans@data@i[1:5]
#the product index/position from each order sequentially
X1_trans@data@p[1:5]
#the cummulative number of iterms from each order
X1_trans@data@Dim
#number of unique products * number of orders
X1_trans@itemInfo$labels[1:5]
#labels contain the product names in our case

library(RColorBrewer)
itemFrequencyPlot(X1_trans,topN=10,type="absolute",col=brewer.pal(8,'Pastel2'), main="Absolute Item Frequency Plot")


#apply apriori rule
X_apri_rule=apriori(X1_trans,parameter=list(supp=0.02, conf=0.5))

inspect(X_apri_rule[1:15])
#if we select orders from the same person/if the number of transactions is not large, the overlapping of products from different products tend to be small - so the rules are mostly of single products!


 summary(X_apri_rule)
 
 
 topRules <- head(X_apri_rule, n = 10, by = "lift")

 library(arulesViz)
 #interactive plot in html
 #plot(topRules, method = "graph",  engine = "htmlwidget",main="Top 10 rules")
  plot(topRules, method = "graph",  main="Top 10 rules")

```


